{% extends "base.html" %}

{% block content %}
<section class="search-section">
  <form class="search-form" method="get" action="/">
    <div class="search-mode-toggle">
      <label>
        <input type="radio" name="mode" value="query" {% if mode != 'upload' %}checked{% endif %}>
        <span>Query</span>
      </label>
      <label>
        <input type="radio" name="mode" value="upload" {% if mode == 'upload' %}checked{% endif %}>
        <span>Upload research paper</span>
      </label>
    </div>

    <div class="search-row">
      <input
        type="text"
        name="q"
        class="search-input"
        placeholder="Search by topic, method, dataset, problem..."
        value="{{ query }}"
      >

      <select name="search_type" class="search-type-select">
        <option value="hybrid" {% if search_type == 'hybrid' %}selected{% endif %}>Hybrid</option>
        <option value="papers" {% if search_type == 'papers' %}selected{% endif %}>Papers only</option>
        <option value="concepts" {% if search_type == 'concepts' %}selected{% endif %}>Concepts</option>
      </select>

      <button type="submit" class="primary-btn">
        <span class="icon">üîç</span>
        <span>Search</span>
      </button>
    </div>

    <div class="weights-row">
      <label class="weight-label">
        Paper weight
        <input type="number" step="0.1" min="0" max="1" name="paper_weight" value="{{ '%.2f'|format(paper_weight) }}">
      </label>
      <label class="weight-label">
        Concept weight
        <input type="number" step="0.1" min="0" max="1" name="concept_weight" value="{{ '%.2f'|format(concept_weight) }}">
      </label>

      <!-- Hidden pagination state preserved on new searches -->
      <input type="hidden" name="paper_page" value="{{ paper_page }}">
      <input type="hidden" name="author_page" value="{{ author_page }}">
      <input type="hidden" name="venue_page" value="{{ venue_page }}">
    </div>
  </form>

  <form
    id="upload-form"
    class="upload-form"
    method="post"
    action="{{ url_for('main.upload_and_search') }}"
    enctype="multipart/form-data"
    {% if mode != 'upload' %}style="display:none"{% endif %}
  >
    <label class="file-input-label">
      <span class="icon">üìÑ</span>
      <span>Select a text file with your paper (title + abstract)</span>
      <input type="file" name="paper_file" accept=".txt,.md,.tex,.csv,.log,.json,.py,.ipynb">
    </label>
    <button type="submit" class="secondary-btn">Search from file</button>
  </form>
</section>

<section class="results-grid">
  <!-- Left large pane: Papers / Concepts -->
  <section class="panel panel-papers">
    <div class="panel-header">
      {% if search_type == 'concepts' %}
        <h2>Concepts</h2>
      {% else %}
        <h2>Papers</h2>
      {% endif %}
      {% if query %}
        <span class="panel-subtitle">for ‚Äú{{ query[:80] }}{% if query|length > 80 %}‚Ä¶{% endif %}‚Äù</span>
      {% endif %}
    </div>

    <div class="panel-body">
      {% if not query %}
        <p class="muted">Type a query or upload a research paper to see results.</p>
      {% else %}
        {% if search_type == 'concepts' %}
          {% if concept_results %}
            <ul class="concept-list">
              {% for c in concept_results %}
                <li class="concept-card">
                  <div class="concept-main">
                    <span class="concept-name">{{ c.name or c.concept_id }}</span>
                    {% if c.similarity is defined %}
                      <span class="pill score-pill">sim {{ '%.3f'|format(c.similarity) }}</span>
                    {% endif %}
                  </div>
                  {% if c.description %}
                    <p class="concept-desc">{{ c.description }}</p>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">No concepts found for this query.</p>
          {% endif %}
        {% else %}
          {% if paper_results %}
            <ul class="paper-list">
              {% for p in paper_results %}
                <li class="paper-card">
                  <div class="paper-header-line">
                    <h3 class="paper-title">{{ p.title or ('Paper #' ~ p.paper_id) }}</h3>
                    {% if p.similarity is defined %}
                      <span class="pill score-pill">score {{ '%.3f'|format(p.similarity or p.combined_score or 0) }}</span>
                    {% elif p.combined_score is defined %}
                      <span class="pill score-pill">score {{ '%.3f'|format(p.combined_score) }}</span>
                    {% endif %}
                  </div>

                  {% if p.abstract %}
                    <p class="paper-abstract">
                      {{ p.abstract[:350] }}{% if p.abstract|length > 350 %}‚Ä¶{% endif %}
                    </p>
                  {% endif %}

                  <div class="paper-meta">
                    {% set ext = p.external_ids or {} %}
                    {% set openalex_id = ext.get('openalex') if ext.__class__.__name__ == 'dict' else None %}
                    {% if openalex_id %}
                      <a
                        class="text-link"
                        href="https://openalex.org/{{ openalex_id }}"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        <span class="icon">üåê</span>
                        View on OpenAlex
                      </a>
                    {% endif %}

                    {% if p.concepts %}
                      <div class="concept-tags">
                        {% for tag in p.concepts[:6] %}
                          <span class="pill concept-pill">{{ tag }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">No papers found for this query.</p>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>

    {% if query and search_type != 'concepts' %}
      <div class="panel-footer pagination-footer">
        {% set base_params = request.args.to_dict() %}
        {% set prev_page = paper_page - 1 %}
        {% set next_page = paper_page + 1 %}
        <div class="pagination-controls">
          {% if paper_page > 1 %}
            {% set base_params = base_params.copy() %}
            {% set _ = base_params.update({'paper_page': prev_page}) %}
            <a href="{{ url_for('main.index', **base_params) }}" class="ghost-btn">‚Üê Previous</a>
          {% endif %}
          <span class="current-page-pill">
            Page {{ paper_page }}
          </span>
          {% if paper_results|length >= limit %}
            {% set base_params2 = request.args.to_dict() %}
            {% set _ = base_params2.update({'paper_page': next_page}) %}
            <a href="{{ url_for('main.index', **base_params2) }}" class="ghost-btn">Next ‚Üí</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </section>

  <!-- Top right: Authors -->
  <section class="panel panel-authors">
    <div class="panel-header">
      <h2>Authors</h2>
    </div>
    <div class="panel-body">
      {% if authors_results %}
        <ul class="author-list">
          {% for a in authors_results %}
            <li class="author-row">
              <span class="author-name">{{ a.name }}</span>
              <span class="pill">{{ a.paper_count }} paper{{ 's' if a.paper_count != 1 }}</span>
            </li>
          {% endfor %}
        </ul>
      {% elif query %}
        <p class="muted">No author information found for these results.</p>
      {% else %}
        <p class="muted">Run a search to see prominent authors.</p>
      {% endif %}
    </div>

    {% if query and authors_results %}
      <div class="panel-footer pagination-footer">
        {% set base_params = request.args.to_dict() %}
        {% set prev_page = author_page - 1 %}
        {% set next_page = author_page + 1 %}
        <div class="pagination-controls">
          {% if author_page > 1 %}
            {% set base_params = base_params.copy() %}
            {% set _ = base_params.update({'author_page': prev_page}) %}
            <a href="{{ url_for('main.index', **base_params) }}" class="ghost-btn">‚Üê Previous</a>
          {% endif %}
          <span class="current-page-pill">
            Page {{ author_page }}
          </span>
          {% if authors_results|length >= limit %}
            {% set base_params2 = request.args.to_dict() %}
            {% set _ = base_params2.update({'author_page': next_page}) %}
            <a href="{{ url_for('main.index', **base_params2) }}" class="ghost-btn">Next ‚Üí</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </section>

  <!-- Bottom right: Venues -->
  <section class="panel panel-venues">
    <div class="panel-header">
      <h2>Venues</h2>
    </div>
    <div class="panel-body">
      {% if venue_results %}
        <ul class="venue-list">
          {% for v in venue_results %}
            <li class="venue-row">
              <div class="venue-main">
                <span class="venue-id">{{ v.source_id }}</span>
                <span class="pill score-pill">
                  {{ '%.3f'|format(v.aggregate_score or 0) }}
                </span>
              </div>
              <div class="venue-meta">
                <span class="muted small">
                  {{ (v.papers|length if v.papers is defined else 0) }} paper{{ 's' if (v.papers|length if v.papers is defined else 0) != 1 }}
                </span>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% elif query %}
        <p class="muted">No venues found for this query yet.</p>
      {% else %}
        <p class="muted">Run a search to see recommended venues.</p>
      {% endif %}
    </div>

    {% if query and venue_results %}
      <div class="panel-footer pagination-footer">
        {% set base_params = request.args.to_dict() %}
        {% set prev_page = venue_page - 1 %}
        {% set next_page = venue_page + 1 %}
        <div class="pagination-controls">
          {% if venue_page > 1 %}
            {% set base_params = base_params.copy() %}
            {% set _ = base_params.update({'venue_page': prev_page}) %}
            <a href="{{ url_for('main.index', **base_params) }}" class="ghost-btn">‚Üê Previous</a>
          {% endif %}
          <span class="current-page-pill">
            Page {{ venue_page }}
          </span>
          {% if venue_results|length >= limit %}
            {% set base_params2 = request.args.to_dict() %}
            {% set _ = base_params2.update({'venue_page': next_page}) %}
            <a href="{{ url_for('main.index', **base_params2) }}" class="ghost-btn">Next ‚Üí</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </section>
</section>
{% endblock %}
